---
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r pathway_libs, echo=FALSE, results='hide', include=FALSE}
library(dplyr)
library(knitr)
library(tibble)
library(tidyr)

library(GSVA)
library(cluster)
library(parallel)
library(NMF)
library(here)

source(here('munge.R'))
source(here('visualization.R'))
```

```{r chunkopts, echo=FALSE, results='hise', include=FALSE, eval=FALSE}
opts_chunk$set(echo=FALSE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE,
	             cache=TRUE,
	             #cache=FALSE,
               cache_rebuild=TRUE
)
```

## Pathway analysis {.tabset}
Gene set enrichment for key pathways was calculated using [single-sample GSEA]("https://gsea-msigdb.github.io/ssGSEAProjection-gpmodule/v9/index.html").
```{r pathway_config, eval=FALSE}
geneset_f <- '../data/genesets.txt'
hgnc_f <- '../data/hgnc_biomart.tsv.gz'
```

```{r pathway_munge}
emat_pact <- as.matrix(emat[, grepl('^PACT', colnames(emat))])

# Pathway metadata
geneset_meta <- read.delim(geneset_meta_f)

#read pathway file as list of lists
inlist <- strsplit(readLines(geneset_f), "[[:space:]]+")
pathways <- lapply(inlist, tail, n = -1)
names(pathways) <- lapply(inlist, head, n = 1)
pathways <- lapply(pathways, function(x) symbol_check(x, rownames(emat_pact), hgnc))

# Check for missing genes in mat
missing_l <- list()
for(set_name in names(pathways)){
  ii <- pathways[[set_name]]
  missing <-!ii %in% rownames(emat_pact)
  if(any(missing)){
    missing_gene <- ii[missing]
    missing_l[[set_name]] <- missing_gene
    tmp <- paste(missing_gene, collapse=',')
    warning(paste('WARNING:', set_name, 'missing:', tmp))
  }
}
```

```{r pathway_gsva, results='hide'}
#enrich <- gsva(as.matrix(emat), pathways, method="zscore", verbose=FALSE, parallel.sz=4)
enrich <- gsva(as.matrix(emat_pact), pathways, method="ssgsea", verbose=FALSE, parallel.sz=threads)

```

## {.tabset}

### Immune system
```{r pathway_immune, fig.width=16, fig.height=8}
rows <- geneset_meta %>%
  filter(category =='immune') %>%
  pull(gene_set) 

mat <- enrich[rows, ]
if(exists('subtype_df')){
    annCol <- heatmap_annot(sid, mat, subtype_df)
} else {
    annCol <- heatmap_annot(sid, mat)
}

aheatmap(mat, scale = "row", annCol=annCol)

```

### Driver
```{r pathway_driver, fig.width=16, fig.height=8}
rows <- geneset_meta %>%
  filter(category =='driver') %>%
  pull(gene_set) 

mat <- enrich[rows, ]
if(exists('subtype_df')){
    annCol <- heatmap_annot(sid, mat, subtype_df)
} else {
    annCol <- heatmap_annot(sid, mat)
}

aheatmap(mat, scale = "row", annCol=annCol)

```

### Physiology
```{r pathway_physiology, fig.width=16, fig.height=8}
rows <- geneset_meta %>%
  filter(category =='physiology') %>%
  pull(gene_set) 
  
mat <- enrich[rows, ]
if(exists('subtype_df')){
    annCol <- heatmap_annot(sid, mat, subtype_df)
} else {
    annCol <- heatmap_annot(sid, mat)
}

aheatmap(mat, scale = "row", annCol=annCol)

```

### Immunotherapy Response
```{r pathway_bagaev, fig.width=16, fig.height=8}
rows <- geneset_meta %>%
  filter(category =='bagaev') %>%
  pull(gene_set) 
  
mat <- enrich[rows, ]
if(exists('subtype_df')){
    annCol <- heatmap_annot(sid, mat, subtype_df)
} else {
    annCol <- heatmap_annot(sid, mat)
}

aheatmap(mat, scale = "row", annCol=annCol)

```

Bagaev et al. (2021). Conserved pan-cancer microenvironment subtypes predict response to immunotherapy, Cancer Cell, 39, 845-865 [doi: 10.1016/j.ccell.2021.04.014](https://pubmed.ncbi.nlm.nih.gov/34019806/)

### Immune Landscape of Cancer
```{r pathway_rthorsson, fig.width=16, fig.height=8}
rows <- geneset_meta %>%
  filter(category =='thorsson') %>%
  pull(gene_set) 

mat <- enrich[rows, ]
if(exists('subtype_df')){
    annCol <- heatmap_annot(sid, mat, subtype_df)
} else {
    annCol <- heatmap_annot(sid, mat)
}

aheatmap(mat, scale = "row", annCol=annCol)

```

Thorsson et al. (2018). The Immune Landscape of Cancer. Immunity, 48(4), 812-830.e14. [doi: 10.1016/j.immuni.2018.03.023](https://pubmed.ncbi.nlm.nih.gov/29628290/)

### All
```{r pathway_heatmap, fig.width=16, fig.height=12}
if(exists('subtype_df')){
    annCol <- heatmap_annot(sid, emat_pact, subtype_df)
} else {
    annCol <- heatmap_annot(sid, emat_pact)
}

aheatmap(enrich, scale = "row", annCol=annCol)

```

### Metadata
```{r pathway_metadata}
geneset_meta %>%
datatable(
        extensions = dt_ext,
        options = dt_opts,
        rownames=FALSE,
        escape = FALSE
        )
```

### Data
```{r pathway_data}
enrich %>%
datatable(
        extensions = dt_ext,
        options = dt_opts,
        rownames=TRUE,
        escape = FALSE
        )
```

## {-}
